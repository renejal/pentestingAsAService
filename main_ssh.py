#!/usr/bin/python3
# -*- encoding: utf-8 -*-

import paramiko
import argparse
import time

HOST='18.118.100.203'
USERNAME='kali'
KEY_FILE = 'test-server.pem'
PRUEBAS = ['authz_003','config_007','config_008','ident_004','info_003','info_004','info_007']

if __name__ == '__main__':


	parser = argparse.ArgumentParser()
	parser.add_argument("--id_pentest", help="Usuario de prueba. Ej: usuario1,password1",type=int)
	parser.add_argument("--url", help="URL del sitio. Ej: http://www.example.com",type=str)
	parser.add_argument("--dominio", help="Dominio del sitio. Ej: example.com",type=str)
	#parser.add_argument("--ip", help="Ip del sitio. Ej: 10.10.10.10, 192.168.0.10",type=str)
	parser.add_argument("--pruebas", help="Identificadores de las pruebas sin otg separadas por ','. Ej. authz_007,info_003",type=str)

	args = parser.parse_args()
	id_pentest = args.id_pentest
	url = args.url
	dominio = args.dominio
	#ip = args.ip
	pruebas = args.pruebas
	
	
	#id_pentest = 10
	#url = 'http://testphp.vulnweb.com'
	#dominio = 'testphp.vulnweb.com'
	#ip = '45.33.32.156 ' 
	script = 'main.py'
	file_origen = 'report_'+str(id_pentest) + '.pdf'
	file_destino = 'report_'+str(id_pentest) + '.pdf'

	comando = "python3 "+ script +" --id_pentest " +str(id_pentest) +" --url " +url +" --dominio "+dominio +" --prueba "
	
	cliente =  paramiko.SSHClient()
	cliente.set_missing_host_key_policy(paramiko.AutoAddPolicy())
	kwy = paramiko.RSAKey.from_private_key_file(KEY_FILE)
	#cliente.load_system_Host_keys()
	cliente.connect(hostname=HOST, username=USERNAME, pkey=kwy)

	stdin, stdout, stderr = cliente.exec_command(comando + pruebas)
	time.sleep(10)
	result = stdout.read().decode()
	print(result)
	sftp = cliente.open_sftp()
	sftp.get(file_origen, file_destino)
	sftp.remove(file_origen)
	cliente.close()

#python3 main_ssh.py --id_pentest 11 --url http://testphp.vulnweb.com/ --dominio scanme.nmap.org --prueba config_008